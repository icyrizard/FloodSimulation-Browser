Ext.define("app.model.SimulationModel",{extend:"Ext.data.Model",config:{fields:["name","corners","visbounds","area_id","center","size"],},});Ext.define("app.model.SimulationDetails",{extend:"Ext.data.Model",config:{fields:["name","center","corners","size","extents","visbounds","vissize","projection","dikes"],},});Ext.define("app.view.Main",{extend:"Ext.Container",requires:["Ext.TitleBar"],config:{title:"Simulation Browser",layout:"hbox",fullscreen:true,items:[{xtype:"listpanel",width:"20%",style:"border-right: 1px solid #373737",flex:1,},{xtype:"simulationpanel",flex:2}],}});Ext.define("app.view.Simulation",{extend:"Ext.Panel",xtype:"simulationpanel",config:{layout:"card",items:[{docked:"top",xtype:"toolbar",title:"Flood Simulation Browser",},{xtype:"SimulationMap",}],}});Ext.define("app.view.List",{extend:"Ext.navigation.View",xtype:"listpanel",requires:["Ext.data.Store","Ext.dataview.List"],title:"Simulations",config:{navigationBar:{title:"simulations",items:[{id:"simulationOptions",xtype:"button",iconCls:"list",iconMask:true,left:"100%",top:7,ui:["square"],}]},items:[{title:"Locations",id:"cities",xtype:"list",ui:"round",itemTpl:"<div>{name}</div>",store:"SimulationStore",}],},});Ext.define("app.view.Map",{extend:"Ext.Map",xtype:"SimulationMap",id:"mapa",config:{useLoadMask:true,mapOptions:{zoom:12,center:new google.maps.LatLng(52.354453,4.95536),mapTypeId:google.maps.MapTypeId.ROADMAP,navigationControl:true,scrollwheel:true,scaleControl:true,rotateControl:true,panControl:true,overviewMapControl:true,zoomControl:true,navigationControlOptions:{style:google.maps.NavigationControlStyle.DEFAULT}},listeners:{maprender:function(){this.overlayImages=[];this.Images=[];this.imageIndex=0;this.imageBounds=null;this.play=false;this.testId=0;this.areaId=0;this.listener_ref=null;this.marker_listener=null}}},getReference:function(){return this.globalMap},setGlobalMap:function(a,b){this.globalMap=b;this.globalExtMap=a},setCenterMap:function(a){this.globalExtMap.setMapCenter({latitude:a[0],longitude:a[1]})},alterMapOptions:function(a){this.globalExtMap.setMapOptions(a)},createMarker:function(b,a){map=this.globalExtMap;var b=new google.maps.LatLng(b[0],b[1]);if(a!=null){icon=a.icon||"resources/images/Google_Maps_Marker.png";draggable=a.draggable||false;raiseOnDrag=a.raiseOnDrag||false}else{icon="resources/images/Google_Maps_Marker.png";draggable=false;raiseOnDrag=false}marker=new google.maps.Marker({position:b,icon:icon,map:this.globalMap,title:"you",raiseOnDrag:true,draggable:draggable,});if(this.marker_listener!=null){google.maps.event.removeListener(this.marker_listener)}this.marker_listener=google.maps.event.addListener(marker,"dragend",function(c){map.fireEvent("dragend",c)});return marker},createOverlayImage:function(d,g,b,f){var c=this;var a="";if(f=="Flood"){a="http://sangkil.science.uva.nl:8003/drfsm/"+g+"/visualization/level/map/"}else{if(f=="Lsm"){a="http://sangkil.science.uva.nl:8003/lsm/"+g+"/visualization/paru/map/"}else{return false}}this.imageIndex=0;this.imageBounds=new google.maps.LatLngBounds(new google.maps.LatLng(d[2],d[3]),new google.maps.LatLng(d[0],d[1]));this.bounds=d;if(this.overlayImages.length>1){this.removeImages()}for(i in b){var e=new Image();e.src=a+b[i]+".png";this.overlayImages.push(new google.maps.GroundOverlay(e.src,this.imageBounds))}this.overlayImages[0].setMap(this.globalMap);this.imageIndex=this.overlayImages.length;if(this.listeners_ref!=null){google.maps.event.removeListener(this.listeners_ref)}this.listeners_ref=google.maps.event.addListener(this.overlayImages[0],"click",function(h){c.fireEvent("gotClick",h)})},nextImage:function(){var a=this;if(this.overlayImages.length<=1){return}var b=(this.overlayImages.length+this.imageIndex)%this.overlayImages.length;this.imageIndex=(this.overlayImages.length+this.imageIndex+1)%this.overlayImages.length;this.overlayImages[this.imageIndex].setMap(this.globalMap);if(this.listeners_ref!=null){google.maps.event.removeListener(this.listeners_ref)}this.listeners_ref=google.maps.event.addListener(this.overlayImages[this.imageIndex],"click",function(c){a.fireEvent("gotClick",c)});this.overlayImages[b].setMap(null)},prevImage:function(){if(this.overlayImages.length<=1){return}this.overlayImages[this.imageIndex].setMap(null);this.imageIndex-=this.imageIndex>0?1:0;if(this.imageIndex>=0){this.overlayImages[this.imageIndex].setMap(this.globalMap)}},removeImages:function(){for(i in this.overlayImages){this.overlayImages[i].setMap(null)}this.imageIndex=0;this.overlayImages=[];this.Images=[]},createOverlayPolygon:function(a){var d=[];for(var c=0;c<a[0].length-1;c++){d.push(new google.maps.LatLng(a[0][c][0],a[0][c][1]))}var b=new google.maps.Polygon({paths:d,strokeColor:"#FF0000",strokeOpacity:0.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:0.35});b.setMap(this.globalMap)},getCurrentImage:function(){if(this.overlayImages.length>0){this.overlayImages[this.imageIndex];return this.overlayImages[this.imageIndex]}},getFloodImage:function(b,a){if(a){return"http://sangkil.science.uva.nl:8003/drfsm/"+b+"/visualization/level/map/"+a+".png"}else{return false}}});Ext.define("app.view.StepsOverlay",{extend:"Ext.Container",xtype:"StepsOverlay",requires:["Ext.Anim"],config:{id:"overlay",style:"background: none;",html:'<div id="controls_title"><h2>Controls<h2></div>',showAnimation:{type:"slideIn",direction:"left",},hidden:true,width:220,height:130,scroll:false,draggable:true,items:[{xtype:"button",id:"closebutton",top:-10,right:0,ui:"plain",border:"solid",style:"color: white; background: none",html:"x",handler:this.closebutton,scope:this,},{top:30,left:35,align:"center",items:[{xtype:"button",id:"forward",ui:"blue",cls:"overlay-button",width:45,iconCls:"arrow_up",floating:"right",iconMask:true,align:"center",left:40},{top:50,xtype:"button",id:"backwards",ui:"blue",cls:"overlay-button",width:45,floating:"left",iconCls:"arrow_down",align:"center",iconMask:true,left:40},{top:24,xtype:"button",id:"play",ui:"blue",cls:"overlay-button",width:40,floating:"left",iconCls:"arrow_right",align:"center",iconMask:true,left:85,},{top:24,hidden:true,xtype:"button",id:"pause",ui:"red",cls:"overlay-button",width:40,floating:"left",iconCls:"pause",align:"center",iconMask:true,left:85,},{top:24,xtype:"button",id:"play-backw",ui:"blue",cls:"overlay-button",width:40,floating:"left",iconCls:"arrow_left",align:"center",iconMask:true,left:0,},{top:24,hidden:true,xtype:"button",id:"pause-backw",ui:"red",cls:"overlay-button",width:40,floating:"left",iconCls:"pause",align:"center",iconMask:true,left:0,}],}],closebutton:function(){Ext.dispatch({controller:app.controller.Main,action:"closeoverlay"})}}});Ext.define("app.view.OptionsPanel",{extend:"Ext.Panel",xtype:"SimulationOptions",id:"simulation_options",requires:["Ext.dataview.List"],config:{layout:"hbox",right:40,width:200,height:100,hideOnMaskTap:true,modal:true,items:[{xtype:"list",id:"optionsList",width:"100%",itemTpl:"Simulation {type}",data:[{type:"Flood"},{type:"Lsm"}],}],}});Ext.define("app.view.SimulationList",{extend:"Ext.List",xtype:"SimulationList",id:"summary",config:{scrollable:{momentum:false},title:"Floods",fullscreen:true,store:"SimulationsSummary",itemTpl:'<div><img class="map_thumb" id="{test_id}_map"src=""/> <img class="flood_thumb" id="{test_id}_flood"style:"width: 100px;" src=""/><div style:"clear:both"><div id="{test_id}_control" class="control"></div></div><h3><b>submitted:</b></h3> <bold>{submitted}</bold></div></div>'},listeners:{scroll:function(){console.log("scroll")}}});Ext.define("app.view.LsmSimulationList",{extend:"Ext.List",xtype:"LsmSimulationList",id:"lsmsimulation-list",config:{title:"lsm",store:"LsmStore",itemTpl:"{submitted}",}});Ext.define("app.view.Chart",{extend:"Ext.Panel",id:"flood-chart",xtype:"floodChart",requires:["Ext.data.Store"],config:{width:520,height:420,layout:"fit",draggable:true,items:[{xtype:"chart",theme:"Base",animate:true,id:"flood-chart-id",store:",",left:20,width:490,height:400,axes:[{type:"Numeric",position:"left",fields:["volume"],title:"Volume",minimum:0,adjustMinimumByMajorUnit:0,},{type:"Category",position:"bottom",fields:["time"],title:"Time Step",minimum:0,adjustMinimumByMajorUnit:0,}],series:[{type:"line",highlight:false,smooth:true,axis:"left",xField:["time"],yField:["volume"],}],},{xtype:"button",ui:"close",id:"closeChart",left:0,top:0,iconCls:"delete",iconMask:true,}],}});Ext.define("app.controller.Main",{extend:"Ext.app.Controller",config:{refs:{map:"#mapa",sidepanel:"listpanel",api:"api",play:"#play",pause:"#pause",playBackw:"#play-backw",pauseBackw:"#pause-backw",mapView:"SimulationMap",simulationList:{selector:"summary",xtype:"SimulationList",autoCreate:true,},overlay:{selector:"#overlay",xtype:"StepsOverlay",autoCreate:true,},simulationOptions:{selector:"#simulation-options",xtype:"SimulationOptions",autoCreate:true,},simOptionsButton:{selector:"#simulationOptions",autoCreate:true,},optionsList:{selector:"#optionsList",autoCreate:true,},lsmSimulation:{selector:"lsmsimulation-list",xtype:"LsmSimulationList",autoCreate:true,},simulation:"simulationpanel"},control:{"listpanel #cities":{itemtap:"showList",show:"initiateCities"},"listpanel #summary":{itemtap:"simulate",},"#mapa":{maprender:"setMap"},"#closebutton":{tap:"closeoverlay"},"#backwards":{tap:"prevImage"},"#forward":{tap:"nextImage"},"#simulationOptions":{tap:"openSimulationsOptions"},"#pause":{tap:"stopPlayImages"},"#play":{tap:"playImages"},"#pause-backw":{tap:"stopBackwImages"},"#play-backw":{tap:"playBackwImages"},"#optionsList":{itemtap:"changeSimulationType",},"listpanel #lsmsimulation-list":{itemtap:"simulate",}}},init:function(){this.selectedIndex=[];this.SimulType="Flood";this.test_id=null},initiateCities:function(){this.getSimOptionsButton().show()},setMap:function(a,b){this.globalMap=b;this.getMapView().setGlobalMap(a,b)},stopBackwImages:function(a){clearInterval(this.interval);a.hide();this.getPlayBackw().show()},playBackwImages:function(b){this.getPlay().show();this.getPause().hide();clearInterval(this.interval);b.hide();this.getPauseBackw().show();var a=this.getMapView();this.interval=setInterval(function(){a.prevImage()},500)},playImages:function(b){this.getPlayBackw().show();this.getPauseBackw().hide();clearInterval(this.interval);b.hide();this.getPause().show();var a=this.getMapView();this.interval=setInterval(function(){a.nextImage()},500)},stopPlayImages:function(a){clearInterval(this.interval);a.hide();this.getPlay().show();clearInterval(this.interval)},prevImage:function(){this.getMapView().prevImage()},nextImage:function(){this.getMapView().nextImage()},closeoverlay:function(){this.getPlay().show();this.getPause().hide();this.getPlayBackw().show();this.getPauseBackw().hide();clearInterval(this.interval);this.getMapView().removeImages();this.getOverlay().hide()},simulate:function(j,h,e,g){var k=this;this.getMapView().removeImages();var c=this.getMapView(),f=g.get("test_id"),a;this.test_id=f;var d=function(m){var n=m.timesteps||m.images;if(n.length>0){c.createOverlayImage(a,f,n,k.SimulType);c.testId=m.test_id;c.areaId=m.area_id}};var l=Ext.getStore("FloodDetailStore");l.each(function(m){a=m.get("visbounds")});var b="";if(this.SimulType=="Flood"){b="http://sangkil.science.uva.nl:8003/drfsm/"+f+"/info.json"}else{b="http://sangkil.science.uva.nl:8003/lsm/"+f+"/visualization/paru/info.json"}this.requestInfo(f,d,b);this.getOverlay().showBy(this.getMapView(),"tr-tr")},showList:function(l,k,g,j){this.getSimOptionsButton().hide();this.getMapView().removeImages();var c=j.get("center");var e=j.get("area_id");var f=false;for(i in this.selectedIndex){if(this.selectedIndex[i]==k){f=true}}var m=Ext.getStore("SimulationsSummary");var d=Ext.getStore("LsmStore");d.clearFilter();d.filter("area_id",e);m.clearFilter();m.filter("area_id",e);if(this.SimulType=="Flood"){this.setThumb(c);this.getSidepanel().push(this.getSimulationList())}else{if(this.SimulType=="Lsm"){this.getSidepanel().push(this.getLsmSimulation())}}var m=Ext.getStore("FloodDetailStore");m.setUrl(e);m.load();if(f==false){var b=null;var a=j.get("visbounds");var h=j.get("corners");this.selectedIndex.push(k);m.each(function(n){b=n.get("dikes")});if(b.length!=0){this.getMapView().createOverlayPolygon(b)}this.getMapView().createMarker(c);this.getSimulationOptions().show();this.getSimulationOptions().hide()}this.getMapView().setCenterMap(c);this.getMapView().alterMapOptions({zoom:13})},setThumb:function(){if(typeof this.test_id==undefined){return}var b=this;var a=Ext.getStore("SimulationsSummary");a.each(function(d){var e=d.get("test_id");var c=function(f){var g=b.getMapView().getFloodImage(e,f.timesteps[f.timesteps.length-1])||"resources/images/noimage.png";document.getElementById(e+"_flood").src=g};b.requestInfo(d.get("test_id"),c)})},requestInfo:function(b,d,a){var a=a||"http://sangkil.science.uva.nl:8003/drfsm/"+b+"/info.json";var c=Ext.Ajax.request({method:"GET",url:a,success:function(f,g){var e=Ext.decode(f.responseText);d(e)},failure:function(){console.log("failed to create images")}})},openSimulationsOptions:function(a){this.getSimulationOptions().showBy(a)},closeSimulationsOptions:function(a){this.getSimulationOptions().hide()},changeSimulationType:function(d,b,c,a){if(a.get("type")=="Lsm"&&this.SimulType!="Lsm"){this.SimulType="Lsm"}else{if(a.get("type")=="Flood"&&this.SimulType!="Flood"){this.SimulType="Flood"}}this.getSimulationOptions().hide()},});Ext.define("app.store.SimulationStore",{extend:"Ext.data.Store",requires:["Ext.data.proxy.Rest"],id:"simulationList",config:{autoLoad:true,fields:["name","corners","visbounds","area_id","center"],proxy:{type:"rest",url:"http://sangkil.science.uva.nl:8003/area/list.json",reader:{type:"json",rootProperty:"areas"},}}});Ext.define("app.store.FloodDetailStore",{extend:"Ext.data.Store",requires:["Ext.data.proxy.Rest"],xtype:"FloodDetailStore",config:{autoLoad:true,fields:["name","center","corners","size","extents","visbounds","vissize","projection","dikes"],proxy:{type:"rest",url:"http://sangkil.science.uva.nl:8003/area/1/info.json",reader:{type:"json",},},listeners:{}},setUrl:function(b){var a=Ext.getStore("FloodDetailStore").getProxy();a._url="http://sangkil.science.uva.nl:8003/area/"+b+"/info.json"},});Ext.define("app.store.SimulationsSummary",{extend:"Ext.data.Store",requires:["Ext.data.proxy.Rest"],config:{autoLoad:true,fields:["area_id","test_id","submitted"],proxy:{type:"rest",url:"http://sangkil.science.uva.nl:8003/drfsm/list.json?summary",reader:{type:"json",rootProperty:"simulations"}}},});Ext.define("app.store.LsmStore",{extend:"Ext.data.Store",config:{autoLoad:true,fields:["area_id","test_id","submitted"],proxy:{type:"rest",url:"http://sangkil.science.uva.nl:8003/lsm/list.json",reader:{type:"json",rootProperty:"simulations"}}}});Ext.define("app.store.chartStore",{extend:"Ext.data.JsonStore",config:{fields:["time","volume"]}});Ext.define("app.Api",{mixins:["Ext.mixin.Observable"],singleton:true,getIzid:function(d,a,c){var b=this;var e=Ext.Ajax.request({method:"GET",url:"http://sangkil.science.uva.nl:8003/area/"+c+"/izid.json?latlng="+d+","+a,success:function(g,h){var f=Ext.decode(g.responseText);b.fireEvent("gotIzid",f.izid)},failure:function(){console.log("getIzid: failed to get izid")}})},getCsvFile:function(a,d){var b=this;var c=Ext.Ajax.request({method:"GET",url:"http://sangkil.science.uva.nl:8003/drfsm/"+a+"/results/izid/"+d+".csv",success:function(e,f){b.fireEvent("gotCsv",e.responseText)},failure:function(){console.log("getCsvFile: failed to get csv file")}})},requestInfo:function(b,d,a){var a=a||"http://sangkil.science.uva.nl:8003/drfsm/"+b+"/info.json";var c=Ext.Ajax.request({method:"GET",url:a,success:function(f,g){var e=Ext.decode(f.responseText);d(e)},failure:function(){console.log("failed to create images")}})}});Ext.define("app.controller.ChartController",{extend:"Ext.app.Controller",requires:["app.Api"],config:{refs:{Floodchart:{xtype:"floodChart",selector:"flood-chart",autoCreate:true,},ChartData:{selector:"flood-chart-id",autoCreate:true,},ExpandButton:"#expand-button",mapView:"SimulationMap",},control:{"#mapa":{maprender:"addListener"},"#closeChart":{tap:"closeFloodChart"},"#expand-button":{tap:"expandChart"},},},init:function(){self.marker=null;map=this.getMapView();app.Api.on({gotIzid:function(a){app.Api.getCsvFile(map.testId,a)},gotCsv:function(a){me.plot(a)}})},addListener:function(){me=this;map=this.getMapView();map.on({gotClick:function(a){if(self.marker!=null){self.marker.setMap(null);self.marker=null}lat=a.latLng.lat();lng=a.latLng.lng();options={icon:"resources/images/marker.png",draggable:true,raiseOnDrag:true,};self.marker=map.createMarker([lat,lng],options);app.Api.getIzid(lat,lng,map.areaId)},dragend:function(a){console.log(a);lat=a.latLng.lat();lng=a.latLng.lng();app.Api.getIzid(lat,lng,map.areaId)}})},plot:function(a){array=a.split("\n");store=Ext.getStore("chartStore");columns=array[0];volume=[];time=[];data=[];for(i=1;i<array.length;i++){line_clmns=array[i].split(",");data.push({time:parseInt(line_clmns[0]),volume:parseInt(line_clmns[2]),})}store.setData(data);this.openChart()},openChart:function(){this.getFloodchart().showBy(this.getMapView(),"t-t")},closeFloodChart:function(){this.getFloodchart().hide()},expandChart:function(){}});Ext.application({controllers:["Main","ChartController"],models:["SimulationModel","SimulationDetails"],stores:["SimulationStore","FloodDetailStore","SimulationsSummary","LsmStore","chartStore"],name:"app",requires:["Ext.MessageBox",],views:["Main","Simulation","List","Map","StepsOverlay","OptionsPanel","SimulationList","LsmSimulationList","Chart"],icon:{57:"resources/icons/Icon.png",72:"resources/icons/Icon~ipad.png",114:"resources/icons/Icon@2x.png",144:"resources/icons/Icon~ipad@2x.png"},phoneStartupScreen:"resources/loading/Homescreen.jpg",tabletStartupScreen:"resources/loading/Homescreen~ipad.jpg",launch:function(){Ext.fly("appLoadingIndicator").destroy();Ext.Viewport.add(Ext.create("app.view.Main"))},onUpdated:function(){Ext.Msg.confirm("Application Update","This application has just successfully been updated to the latest version. Reload now?",function(){window.location.reload()})}});